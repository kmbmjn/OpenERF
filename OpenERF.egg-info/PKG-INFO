Metadata-Version: 2.4
Name: OpenERF
Version: 0.2.0
Summary: One-line Effective Receptive Field extraction for pretrained timm models
Author: OpenERF Contributors
License: MIT License
        
        Copyright (c) 2026 OpenERF Contributors
        
        Permission is hereby granted, free of charge, to any person obtaining a copy
        of this software and associated documentation files (the "Software"), to deal
        in the Software without restriction, including without limitation the rights
        to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
        copies of the Software, and to permit persons to whom the Software is
        furnished to do so, subject to the following conditions:
        
        The above copyright notice and this permission notice shall be included in all
        copies or substantial portions of the Software.
        
        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
        IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
        AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
        LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
        OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
        SOFTWARE.
        
        
Requires-Python: >=3.9
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: torch>=2.2
Requires-Dist: torchvision>=0.17
Requires-Dist: timm>=1.0.22
Requires-Dist: numpy>=1.24
Requires-Dist: Pillow>=10.0
Requires-Dist: tqdm>=4.66
Requires-Dist: matplotlib>=3.8
Provides-Extra: fit
Requires-Dist: lmfit>=1.3; extra == "fit"
Requires-Dist: scipy>=1.10; extra == "fit"
Dynamic: license-file

# OpenERF

OpenERF is a Python library for extracting **Effective Receptive Field (ERF)** maps from pretrained `timm` models in one line.

This repository currently focuses on representative ImageNet ResNets (`resnet18.a1_in1k`, `resnet34.a1_in1k`, `resnet50.a1_in1k`) and uses `imagenet_val_1000` for practical runtime.

```python
import OpenERF
import timm

model_name = "resnet34.a1_in1k"
model = timm.create_model(model_name, pretrained=True)
OpenERF.save_ERF(model, model_name=model_name)
```

Default output:
- `./results/OpenERF_<model_name>.png`

Key protocol details handled by OpenERF:
- Model-specific preprocessing from `timm` config (`mean/std`, interpolation, `crop_pct`)
- ERF accumulation with fixed `batch_size=1`
- Positive input-gradient accumulation at feature-map center
- Colored PNG export with matplotlib colormap (default: `plasma`)

## Installation

```bash
pip install -r requirements.txt
pip install -e .
```

Optional Gaussian fitting support:

```bash
pip install -e ".[fit]"
```

## Getting_Started

### 1) One-line ERF extraction

```python
import OpenERF
import timm

model_name = "resnet34.a1_in1k"
model = timm.create_model(model_name, pretrained=True)

result = OpenERF.save_ERF(
    model,
    model_name=model_name,
    image_dir="./imagenet_val_1000",
)
print(result["save_path"])
```

### 2) Save additional artifacts (`.npy` + metrics JSON)

```python
result = OpenERF.save_ERF(
    model,
    model_name="resnet34.a1_in1k",
    image_dir="./imagenet_val_1000",
    save_numpy=True,
    save_metrics=True,
)
print(result["npy_path"])
print(result["metrics_path"])
```

### 3) Optional 2D Gaussian fit (`lmfit`)

```python
result = OpenERF.save_ERF(
    model,
    model_name="resnet34.a1_in1k",
    fit_gaussian=True,
)
print(result["gaussian_fit"]["sigma_x"], result["gaussian_fit"]["sigma_y"])
```

## Example

`example.py` runs ERF extraction for representative ResNets:
- `resnet18.a1_in1k`
- `resnet34.a1_in1k`
- `resnet50.a1_in1k`

Run:

```bash
python example.py \
  --image-dir ./imagenet_val_1000 \
  --max-images 1000
```

Useful options:
- `--model-names resnet18.a1_in1k resnet34.a1_in1k resnet50.a1_in1k`
- `--device mps` or `--device cuda`
- `--fit-gaussian`
- `--no-progress`
- `--output-suffix _run1`

## API

### `OpenERF.compute_ERF(...)`

Computes ERF in memory and returns:
- `erf_map`
- `num_images`
- `data_config`
- optional `gaussian_fit`

### `OpenERF.save_ERF(...)`

Computes ERF and saves PNG. Optional outputs:
- `.npy` (`save_numpy=True`)
- metrics JSON (`save_metrics=True`)

## Licenses

This repository is released under the MIT License.

See [LICENSE](./LICENSE).

## Citing

If this project is useful for your work, please cite:

```bibtex
@article{kim2023deadpixel,
  title={Dead pixel test using effective receptive field},
  author={Kim, Bum Jun and Choi, Hyeyeon and Jang, Hyeonjun and Lee, Dong Geun and Jeong, Woojin and Kim, Sunghwan},
  journal={Pattern Recognition Letters},
  volume={167},
  pages={149--156},
  year={2023}
}
```

```bibtex
@inproceedings{kim2023gaussian,
  title={Understanding Gaussian Attention Bias of Vision Transformers Using Effective Receptive Fields},
  author={Kim, Sunghwan and Kim, Bum Jun and Choi, Hyeyeon and Jang, Hyeonjun and Lee, Dong Geun},
  booktitle={British Machine Vision Conference (BMVC)},
  year={2023}
}
```
